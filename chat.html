<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>与 Anna 对话 - 安娜AI</title>
    <link rel="icon" href="icon.png" type="image/x-icon">
    <style>
        :root {
            --olive: #7b6c3a;
            --slate: #5f6f87;
            --blue: #2f6da5;
            --silver: #9fb2bd;
            --umber: #6a5232;
            --sand: #e7dc9c;
            --sage: #d6e1d4;
            --eggshell: #f4f3e3;
            --ivory: #f7f4dd;
            --outline: #cdd6e3;
            --text-primary: #2e3642;
            --text-secondary: #5d6470;
            --space-0-5: 6px;
            --space-1: 12px;
            --space-2: 24px;
            --space-3: 36px;
            --space-4: 48px;
            --space-5: 60px;
            --space-6: 72px;
            --space-7: 84px;
            --space-8: 96px;
            --space-9: 108px;
            --space-10: 120px;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--eggshell);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header, main, footer {
            width: min(1080px, 100% - clamp(var(--space-2), 8vw, var(--space-10)));
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: clamp(var(--space-2), 6vw, var(--space-6));
            padding-bottom: clamp(var(--space-1), 2vw, var(--space-2));
        }

        .logo {
            font-weight: 700;
            letter-spacing: 0.08em;
            font-size: 1rem;
            margin-top: var(--space-1);
            color: var(--slate);
        }
        .badge {
            padding: var(--space-0-5) var(--space-1);
            border: 1px solid var(--slate);
            border-radius: 999px;
            font-size: 0.8rem;
            margin-top: var(--space-1);
            color: var(--slate);
        }

        main {
            flex: 1;
            padding-bottom: clamp(var(--space-3), 8vh, var(--space-7));
        }

        .chat-card {
            background: #fff;
            border: 1px solid var(--outline);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            padding: var(--space-2);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            min-height: min(72vh, 840px);
            width: clamp(420px, 56vw, 600px);
            margin: 0 auto;
            position: relative;
        }

        .chat-topbar {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding-bottom: var(--space-1);
            border-bottom: 1px solid var(--outline);
        }
        .avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--blue);
            color: #fff; display: grid; place-items: center;
            font-weight: 800; letter-spacing: 0.04em;
        }
        .title {
            margin: 0; font-weight: 800; letter-spacing: 0.02em; font-size: 1.05rem;
        }
        .subtitle {
            margin: 2px 0 0 0; color: var(--text-secondary); font-size: .9rem;
        }

        /* 历史记录按钮与面板 */
        .history-button {
            margin-left: auto;
            padding: var(--space-0-5) var(--space-1);
            border: 1px solid var(--outline);
            border-radius: 999px;
            background: #fff;
            color: var(--slate);
            font-weight: 600;
            cursor: pointer;
        }
        .history-button:hover, .history-button:focus {
            background: var(--ivory);
        }
        .history-panel {
            position: absolute;
            top: var(--space-1);
            right: var(--space-1);
            width: clamp(240px, 36vw, 320px);
            max-height: min(60vh, 480px);
            overflow: auto;
            background: #fff;
            border: 1px solid var(--outline);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            display: none;
            z-index: 10;
        }
        .history-panel[aria-hidden="false"] { display: block; }
        .history-list { list-style: none; margin: 0; padding: var(--space-1); display: flex; flex-direction: column; gap: var(--space-0-5); }
        .history-item { padding: var(--space-1); border-radius: 10px; border: 1px solid transparent; cursor: pointer; }
        .history-item:hover { background: var(--ivory); border-color: var(--outline); }
        .history-item--active { background: var(--sage); border-color: var(--outline); }
        .history-empty { padding: var(--space-1); color: var(--text-secondary); }

        .chat-messages { flex: 1; overflow-y: auto; padding-right: 2px; }
        .chat-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: var(--space-1); }

        .msg {
            display: inline-block;
            max-width: 80%;
            padding: var(--space-1) var(--space-2);
            border-radius: 12px;
            line-height: 1.6;
            opacity: 0; transform: translateY(6px);
            animation: msgIn 600ms ease forwards;
        }
        .msg--ai { background: var(--ivory); border: 1px solid var(--outline); color: var(--text-primary); }
        .msg--user { background: var(--blue); color: #fff; margin-left: auto; }
        @keyframes msgIn { to { opacity: 1; transform: translateY(0); } }

        .composer {
            display: grid; grid-template-columns: 1fr auto; gap: var(--space-1);
            border-top: 1px solid var(--outline); padding-top: var(--space-1);
        }
        .composer-input {
            width: 100%; padding: var(--space-1) var(--space-2);
            border: 1px solid var(--outline); border-radius: 12px;
            background: var(--ivory); color: var(--text-primary); font-size: 1rem;
        }
        .composer-input::placeholder { color: var(--text-secondary); opacity: .8; }
        .send-button {
            padding: var(--space-1) var(--space-2); background: var(--blue); color: #fff;
            border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
            transition: background-color .2s ease;
        }
        .send-button:hover, .send-button:focus { background-color: #295985; }

        footer {
            padding-bottom: clamp(var(--space-3), 6vh, var(--space-7));
            font-size: .85rem; color: var(--text-secondary); text-align: center;
        }

        /* 无障碍隐藏：保留给屏幕阅读器，不占布局 */
        .sr-only {
            position: absolute !important;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0);
            white-space: nowrap; border: 0;
        }

        @media (max-width: 960px) {
            header { padding-top: clamp(var(--space-1), 4vw, var(--space-3)); }
            .chat-card { padding: var(--space-1); border-radius: 12px; }
            .send-button { width: auto; }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { transition: none !important; animation: none !important; }
        }
    </style>
</head>
<body>
    <header>
        <span class="logo">AnnaAI.app</span>
        <span class="badge">绝对保密</span>
    </header>

    <main>
        <section class="chat-card" aria-label="与 Anna 的聊天">
            <div class="chat-topbar" role="heading" aria-level="1">
                <div class="avatar" aria-hidden="true">A</div>
                <div>
                    <p class="title">Anna</p>
                    <p class="subtitle">心理咨询</p>
                </div>
                <button id="history-btn" class="history-button" aria-haspopup="dialog" aria-expanded="false" aria-controls="history-panel">聊天记录</button>
            </div>

            <aside id="history-panel" class="history-panel" role="dialog" aria-hidden="true" aria-labelledby="history-title">
                <h2 id="history-title" class="sr-only">聊天记录</h2>
                <ul id="history-list" class="history-list" role="listbox" aria-label="历史会话列表"></ul>
                <div id="history-empty" class="history-empty" style="display:none;">暂无历史记录</div>
            </aside>

            <div class="chat-messages">
                <ul class="chat-list" id="chat-list"></ul>
            </div>

            <form class="composer" id="chat-form" onsubmit="return false;" autocomplete="off">
                <label for="composer-input" class="sr-only">输入你的消息</label>
                <input id="composer-input" class="composer-input" type="text" placeholder="说点什么… 按 Enter 发送">
                <button class="send-button" id="send-btn" type="submit">发送</button>
            </form>
        </section>
    </main>

    <footer>
        AnnaAI 不记录任何用户数据。安全感来自每一次被理解的瞬间。
    </footer>

    <script>
    (function(){
        const listEl = document.getElementById('chat-list');
        const formEl = document.getElementById('chat-form');
        const inputEl = document.getElementById('composer-input');
        const historyBtn = document.getElementById('history-btn');
        const historyPanelEl = document.getElementById('history-panel');
        const historyListEl = document.getElementById('history-list');
        const historyEmptyEl = document.getElementById('history-empty');

        let typingController = null;

        const STORAGE_KEYS = {
            sessions: 'anna.sessions',
            currentId: 'anna.currentSessionId'
        };

        function loadSessions(){
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.sessions);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch(e){
                return [];
            }
        }

        function saveSessions(sessions){
            try {
                localStorage.setItem(STORAGE_KEYS.sessions, JSON.stringify(sessions || []));
            } catch(e) { /* ignore */ }
        }

        function getCurrentSessionId(){
            try { return localStorage.getItem(STORAGE_KEYS.currentId) || null; } catch(e){ return null; }
        }

        function setCurrentSessionId(id){
            try { if (id) localStorage.setItem(STORAGE_KEYS.currentId, id); else localStorage.removeItem(STORAGE_KEYS.currentId); } catch(e) { /* ignore */ }
        }

        function findSessionById(sessions, id){
            return sessions.find(s => s && s.id === id) || null;
        }

        function getLatestSessionId(sessions){
            if (!sessions.length) return null;
            const sorted = [...sessions].sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
            return sorted[0].id;
        }

        function createNewSession(){
            const id = String(Date.now());
            return { id, title: '新的会话', messages: [], updatedAt: Date.now() };
        }

        function upsertSession(session){
            const sessions = loadSessions();
            const idx = sessions.findIndex(s => s.id === session.id);
            if (idx >= 0) sessions[idx] = session; else sessions.push(session);
            session.updatedAt = Date.now();
            saveSessions(sessions);
            renderHistoryList();
        }

        function ensureActiveSession(){
            let sessions = loadSessions();
            let currentId = getCurrentSessionId();
            let session = currentId ? findSessionById(sessions, currentId) : null;
            if (!session){
                if (!sessions.length){
                    session = createNewSession();
                    sessions.push(session);
                    saveSessions(sessions);
                } else {
                    const latestId = getLatestSessionId(sessions);
                    session = findSessionById(sessions, latestId);
                }
                setCurrentSessionId(session.id);
            }
            return session;
        }

        function setSessionTitleIfEmpty(session, firstUserText){
            if (!session.title || session.title === '新的会话'){
                const t = (firstUserText || '').trim();
                session.title = t ? (t.length > 16 ? t.slice(0,16) + '…' : t) : '会话';
            }
        }

        function clearChat(){
            listEl.innerHTML = '';
        }

        function renderSession(session){
            clearChat();
            (session.messages || []).forEach(m => {
                appendMessage(m.text || '', m.role === 'ai');
            });
        }

        function renderHistoryList(){
            const sessions = loadSessions();
            const currentId = getCurrentSessionId();
            historyListEl.innerHTML = '';
            historyEmptyEl.style.display = sessions.length ? 'none' : 'block';
            const sorted = [...sessions].sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
            sorted.forEach(s => {
                const li = document.createElement('li');
                li.className = 'history-item' + (s.id === currentId ? ' history-item--active' : '');
                li.setAttribute('role','option');
                li.dataset.id = s.id;
                li.textContent = s.title || '未命名会话';
                historyListEl.appendChild(li);
            });
        }

        function openHistoryPanel(){
            renderHistoryList();
            historyPanelEl.setAttribute('aria-hidden','false');
            historyBtn.setAttribute('aria-expanded','true');
        }

        function closeHistoryPanel(){
            historyPanelEl.setAttribute('aria-hidden','true');
            historyBtn.setAttribute('aria-expanded','false');
        }

        function appendMessage(text, isAI){
            const li = document.createElement('li');
            li.className = 'msg ' + (isAI ? 'msg--ai' : 'msg--user');
            li.textContent = text;
            listEl.appendChild(li);
            listEl.parentElement.scrollTop = listEl.parentElement.scrollHeight;
            return li;
        }

        async function typeStream(targetEl, fullText, chunk = 2, delay = 40){
            if (typingController) typingController.abort();
            typingController = new AbortController();
            const { signal } = typingController;
            targetEl.textContent = '';
            let i = 0;
            while (i < fullText.length) {
                if (signal.aborted) return;
                targetEl.textContent += fullText.slice(i, i + chunk);
                i += chunk;
                await new Promise(r => setTimeout(r, delay));
            }
        }

        function sanitized(text){ return (text || '').replace(/\s+/g, ' ').trim(); }

        function generateMockReply(userText){
            const t = sanitized(userText);
            const core = t ? `我听见你刚刚提到“${t}”。` : '我在。';
            return `${core} 我们先从可被描述的事实入手，再到你的感受与担心，最后一起找一个今天就能迈出的最小行动。`;
        }

        async function handleSend(){
            const q = sanitized(inputEl.value);
            if(!q) return;

            // 用户消息渲染
            appendMessage(q, false);
            inputEl.value = '';

            // 确保会话并保存用户消息
            const sessions = loadSessions();
            let currentId = getCurrentSessionId();
            let session = currentId ? findSessionById(sessions, currentId) : null;
            if (!session){
                const newSession = createNewSession();
                setSessionTitleIfEmpty(newSession, q);
                newSession.messages.push({ role: 'user', text: q, ts: Date.now() });
                sessions.push(newSession);
                saveSessions(sessions);
                setCurrentSessionId(newSession.id);
                renderHistoryList();
                session = newSession;
            } else {
                setSessionTitleIfEmpty(session, q);
                session.messages.push({ role: 'user', text: q, ts: Date.now() });
                session.updatedAt = Date.now();
                const idx = sessions.findIndex(s => s.id === session.id);
                sessions[idx] = session;
                saveSessions(sessions);
                renderHistoryList();
            }

            // AI 回复
            const aiEl = appendMessage('', true);
            const mock = generateMockReply(q);
            await typeStream(aiEl, mock);

            // 保存 AI 消息
            const sessions2 = loadSessions();
            const s2 = findSessionById(sessions2, getCurrentSessionId());
            if (s2){
                s2.messages.push({ role: 'ai', text: mock, ts: Date.now() });
                s2.updatedAt = Date.now();
                const idx2 = sessions2.findIndex(x => x.id === s2.id);
                sessions2[idx2] = s2;
                saveSessions(sessions2);
                renderHistoryList();
            }
        }

        formEl?.addEventListener('submit', handleSend);
        document.getElementById('send-btn')?.addEventListener('click', handleSend);

        // 历史面板交互
        historyBtn?.addEventListener('click', () => {
            const hidden = historyPanelEl.getAttribute('aria-hidden') !== 'false';
            hidden ? openHistoryPanel() : closeHistoryPanel();
        });
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (!historyPanelEl || !historyBtn) return;
            if (historyPanelEl.getAttribute('aria-hidden') === 'true') return;
            if (historyPanelEl.contains(target) || historyBtn.contains(target)) return;
            closeHistoryPanel();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeHistoryPanel();
        });
        historyListEl?.addEventListener('click', (e) => {
            const li = e.target.closest('.history-item');
            if (!li) return;
            const id = li.dataset.id;
            const sessions = loadSessions();
            const session = findSessionById(sessions, id);
            if (session){
                setCurrentSessionId(session.id);
                renderSession(session);
                renderHistoryList();
                closeHistoryPanel();
            }
        });

        // 支持从 ?q=... 自动发送；若存在历史会话则渲染历史，否则播放示例
        (async function init(){
            renderHistoryList();

            const params = new URLSearchParams(window.location.search);
            const q = params.get('q');
            if (q && q.trim()) {
                inputEl.value = q.trim();
                await handleSend();
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('q');
                    window.history.replaceState({}, document.title, url.toString());
                } catch(e) { /* ignore */ }
                return;
            }

            // 若有历史会话，渲染当前或最近一次
            const sessions = loadSessions();
            const currentId = getCurrentSessionId();
            const current = currentId ? findSessionById(sessions, currentId) : null;
            if (current && current.messages && current.messages.length){
                renderSession(current);
                return;
            }
            if (!current && sessions.length){
                const latestId = getLatestSessionId(sessions);
                const latest = findSessionById(sessions, latestId);
                if (latest){ setCurrentSessionId(latest.id); renderSession(latest); return; }
            }

            // 初始演示对话（假数据）
            const intro = appendMessage('', true);
            await typeStream(intro, '你好，我是 Anna。这里绝对保密。你愿意从最近让你挂心的一件小事说起吗？', 2, 35);
            setTimeout(() => appendMessage('最近总是睡不好。', false), 500);
            setTimeout(async () => {
                const ai = appendMessage('', true);
                await typeStream(ai, '谢谢你信任地分享。影响睡眠的因素可以从“身体感觉 / 想法与担心 / 环境触发”三类来找线索。你更想从哪一类开始？', 2, 35);
            }, 1200);
        })();
    })();
    </script>
</body>
</html>
